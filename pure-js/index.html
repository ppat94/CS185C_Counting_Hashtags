<html>
  <head>
    <title>Twitter Trends</title>

    <script src="https://unpkg.com/deck.gl@^6.0.0/deckgl.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js"></script>

    <style type="text/css">
      body {
        font-family: Helvetica, Arial, sans-serif;
        width: 100vw;
        height: 100vh;
        margin: 0;
      }

      #tooltip:empty {
        display: none;
      }

      #tooltip {
        font-family: Helvetica, Arial, sans-serif;
        font-size: 11px;
        position: absolute;
        padding: 4px;
        margin: 8px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        max-width: 300px;
        font-size: 10px;
        z-index: 9;
        pointer-events: none;
      }

      #control-panel {
        position: absolute;
        background: #fff;
        top: 0;
        left: 0;
        margin: 12px;
        padding: 20px;
        font-size: 12px;
        line-height: 1.5;
        z-index: 1;
      }

      label {
        display: inline-block;
        width: 140px;
      }
    </style>
  </head>

  <body>
    <div id="tooltip"></div>
    <div id="control-panel">
      <div>
        <label>Radius</label>
        <input id="radius" type="range" min="1000" max="20000" step="1000" value="1000"></input>
        <span id="radius-value"></span>
      </div>
      <div>
        <label>Coverage</label>
        <input id="coverage" type="range" min="0" max="1" step="0.1" value="1"></input>
        <span id="coverage-value"></span>
      </div>
      <div>
        <label>Upper Percentile</label>
        <input id="upperPercentile" type="range" min="90" max="100" step="1" value="100"></input>
        <span id="upperPercentile-value"></span>
      </div>
    </div>
  </body>

  <script type="text/javascript">

    const {DeckGL, HexagonLayer} = deck;

    const deckgl = new DeckGL({
      mapboxApiAccessToken: 'pk.eyJ1IjoicHBhdDk0IiwiYSI6ImNqb3IweHZrbjBhdGszd3BkZWp3a2x6aXoifQ.ggKP0zuaUxqs8MFPuSV_2A',
      mapStyle: 'mapbox://styles/mapbox/dark-v9',
      longitude: -1.4157,
      latitude: 52.2324,
      zoom: 6,
      minZoom: 5,
      maxZoom: 15,
      pitch: 40.5
    });

    let data = 'https://raw.githubusercontent.com/lutangar/cities.json/master/cities.json';
    let hashtags = null;
    let hashtag = {};
    let count = 0;

    const OPTIONS = ['radius', 'coverage', 'upperPercentile'];

    const COLOR_RANGE = [
      [1, 152, 189],
      [73, 227, 206],
      [216, 254, 181],
      [254, 237, 177],
      [254, 173, 84],
      [209, 55, 78]
    ];

    const LIGHT_SETTINGS = {
      lightsPosition: [-0.144528, 49.739968, 8000, -3.807751, 54.104682, 8000],
      ambientRatio: 0.4,
      diffuseRatio: 0.6,
      specularRatio: 0.2,
      lightsStrength: [0.8, 0.0, 0.8, 0.0],
      numberOfLights: 2
    };

    OPTIONS.forEach(key => {
      document.getElementById(key).oninput = renderLayer;
    });

    function renderLayer () {
      const options = {};
      OPTIONS.forEach(key => {
        const value = document.getElementById(key).value;
        document.getElementById(key + '-value').innerHTML = value;
        options[key] = Number(value);
      });

      const hexagonLayer = new HexagonLayer({
        id: 'heatmap',
        colorRange: COLOR_RANGE,
        data,
        elevationRange: [0, 1000],
        elevationScale: 250,
        pickable: true,
        onHover: onHover,
        autoHighlight: true,
        extruded: true,
        getPosition: d => [d.lng, d.lat],
        lightSettings: LIGHT_SETTINGS,
        opacity: 1,
        ...options
      });
//console.log('here data',data)
      deckgl.setProps({
        layers: [hexagonLayer]
      });
    }

    d3.csv('hash-2.csv')
      .then(response => {
      //data = response.map(d => [Number(d.long), Number(d.lat)]);
      hashtag = response.map(res => (res.hashtag));
      console.log(hashtag);
      console.log(data);
      //hashtags = hashtag[0];
      renderLayer();
    });

    // function updateTooltip(info) {
    //     const tooltip = d3.select('#tooltip');
    //     const props = info.object ? info.object : null;
    //     let content = '';
    //     if (props) {
    //       const key = getKey(props);
    //       const r = incidents[year][key];
    //       const f = fatalities[year][key];
    //       let content = `<big>${props.name} (${props.state})</big>`;
    //       if (r) {
    //         content += `
    //   <div>
    //     <b>${f}</b> people died in
    //     <b>${r}</b> crashes
    //     on ${props.type === 'SR' ? props.state : props.type}-${props.id}
    //     in <b>${year}</b>
    //   </div>`;
    //       } else {
    //         content += `<div>no accidents recorded in <b>${year}</b></div>`;
    //       }
    //       tooltip.style('display', 'block').style('left', info.x).style('top', info.y).html(content);
    //     } else {
    //       tooltip.style('display', 'none');
    //     }
    //   }

    function onHover (info) {
      const {x, y, object} = info;
      console.log(info);
      if (object) {
        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y}px`;
        tooltip.innerHTML = `
        <div>${object.centroid.join(', ')}</div>
        <div>${object.points.length} active users</div>
        <div>${hashtag[0]}</div>
        `;
      } else {
        tooltip.innerHTML = '';
      }
    }

//     function updateTooltip({x, y, object}) {
//   const tooltip = document.getElementById('tooltip');
//   console.log(object);
//
//   if (object) {
//     tooltip.style.top = `${y}px`;
//     tooltip.style.left = `${x}px`;
//     tooltip.innerHTML = `
// <div><b>Lat: </b></div>
// <div><b>Lon: </b></div>
// <div><b>Hashtag: </b></div>
// <div>${object.centroid.join(', ')}</div>
// `;
//   } else {
//     tooltip.innerHTML = '';
//   }
// }

    // function updateTooltip({x, y, object}) {
    //   const tooltip = document.getElementById('tooltip');
    //   if (object) {
    //     tooltip.style.top = `${y}px`;
    //     tooltip.style.left = `${x}px`;
    //     tooltip.innerHTML = `
    // <div><b>Average Property Value &nbsp;</b></div>
    // <div><div>${object.properties.valuePerSqm} / m<sup>2</sup></div></div>
    // <div><b>Growth</b></div>
    // <div>${Math.round(object.properties.growth * 100)}%</div>
    // `;
    //   } else {
    //     tooltip.innerHTML = '';
    //   }
    // }

  </script>
</html>
